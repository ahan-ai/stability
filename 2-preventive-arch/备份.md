# 原则
- 核心数据必须要有备份（最好是跨 region）和恢复的能力。
- 核心数据必须要有冷备，最好有热备能力。
- 白屏化（故障发生后尽可能还可以白屏化）
- 每日全量备份至少1次

哪些数据需要备份：

- 管控平面数据
- 用户自定义的核心数据（用户需要为额外的备份付费）

管控平面的核心数据是否足够，可以按以下**原则**来校验：

- 如果管控平面所在的机器，全面发生故障，那么依赖当前的冷备，是否可以完整地恢复管控平面的服务。如果数据有缺失，那么可能有部分核心数据没有备份。
- 速度是否可以控制在30min 之内（RTO < 30 min）。如果不能，那么你可能需要想办法完善 SOP。

备份分为冷备和热备：

- 冷备：需要把备份恢复到某个实例里，才能正常使用；
- 热备：备份是随时可用的。比如用 DTS实时进行MySQL数据同步。

|  | 冷备 | 热备 |
| --- | --- | --- |
| 优势 | 逻辑简单，存储成本稍低。可以有多个时间点的“快照”。 | RTO 较小，容灾切换速度较快。RPO 较小，基本上是秒级或分钟级。 |
| 劣势 | RTO较大，因为需要把冷数据加载出来，视数据量的大小，通常需要分钟至小时级别。RPO较大，因为是冷数据备份，因此备份动作通常是周期性进行，最差情况可能丢失一整个周期的数据。 | 通常需要做同步复制，技术方案较复杂。无法防误删除。 |
| 场景 | 数据被误删的恢复 | 容灾，切换到备实例上。 |

# 核心数据存储方案推荐

这里的“核心数据”主要是指管控平面的数据，通常存储于SQL数据库，bytekv数据库、etcd、zk等，数据量不大，但很重要。

- MySQL
- Etcd
- ZooKeeper

用于存储关键核心数据的关键的选型原则：

- 高可用（例如单点故障不丢数据）
- 尽可能不要依赖其它的服务：否则所依赖服务也要考虑高可用、冷热备等一系列问题。
- 具备冷备、热备的能力
- 具备对数据并发修改的控制机制（例如原子性、隔离性、CAS等）

# 容灾要求

![Untitled](https://ahan-ai.notion.site/image/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F6a0a71fd-e2d2-4bb5-9b46-3b3bf7499109%2FUntitled.png?table=block&id=5cd77756-de2e-4123-968c-6e8e01b53b4a&spaceId=3841c813-6aff-406c-8c94-6fa3c0018b15&width=1420&userId=&cache=v2)

应用于金融领域的云计算平台至少达到3级要求。

3级对备份的要求：

- 关键数据至少有1个数据副本处于异地或同城可用区
- 完全数据备份至少每天1次且 处于同城或异地可用区

# 冷备

冷备，通常来说，对于目标端的要求比较高，推荐的做法是把冷备数据存在对象存储服务中。

对象存储通常还有跨 region 同步的功能，直接打开此功能，就可以自动保证数据跨region备份。

## 数据恢复

技术考量点：

- 数据恢复要明确恢复的时间点，时间点越细越好，能恢复到任意时间点最佳。
- 恢复至新实例/恢复至原实例（可能导致原实例保存点之后的新数据丢失）
- 数据恢复尽可能要白屏化，因为在真正发生故障时，使用黑屏可能会手忙脚乱，导致最终的 RTO 非常长。
- 核心数据库故障后，可能白屏化的能力不一定有了，

针对不同的场景，恢复手段也有不同：

1. 数据**完全丢失**（比如被误删所有数据）：
    1. 如果热备正常，且可以切换，那么直接切到热备上继续工作。这样可以继续工作。
    2. 如果热备也不正常（比如热备由于实时同步导致数据也被删光），那么需要用冷备数据恢复。恢复时长可能取决于数据量。
2. 数据**部分丢失**（通常是被软件或者手动误操作删除）。这种时候通常热备也会由于同样的原因，数据部分丢失，因此这时候热备通常也是用不了的。而直接用冷备恢复，又可能导致很多新的数据丢失。因此这时候，可能需要支持精准地恢复丢失的这部分数据：
    1. 确定误操作的时间点；
    2. 从冷备（包含丢失数据）上恢复到新实例
    3. 对比原实例和新实例（包含丢失数据）的 diff，并精确地从新实例处同步部分数据过来。

对于核心数据库而言，最好有备案，可以快速把新实例里的数据（被误删的那些），一键导入到原实例中。

如果数据过于分散，那只能用脚本来实现导出导入了，这种情况下的恢复时间可能就更长了，具体问题具体分析了。

总之，数据恢复，需要根据不同的场景（黑屏/白屏、数据全丢/部分丢失）提前准备好充分的预案，在故障后紧急修复。

# 热备

数据库类的热备通常方案就是DTS。

# 参考资料

**云计算技术金融应用规范 容灾：**

[金融标准全文公开系统](https://www.cfstc.org/bzgk/gk/view/bzxq.jsp?i_id=1877)

**云计算技术金融应用规范 技术架构**

[金融标准全文公开系统](https://www.cfstc.org/bzgk/gk/view/bzxq.jsp?i_id=1875)

**云计算技术金融应用规范 安全技术要求**

[金融标准全文公开系统](https://www.cfstc.org/bzgk/gk/view/bzxq.jsp?i_id=1876)