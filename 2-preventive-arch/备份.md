# 原则
# 为什么需要备份

备份是一种基本而必要的稳定性策略，它的意义在于帮助企业和个人应对各种可能导致数据丢失或不可用的风险。这些风险包括但不限于自然灾害、意外操作、恶意攻击和技术故障。例如：

- **容灾：应对自然灾害和硬件故障。**数据存储设备并非万无一失，自然灾害如地震、洪水或火灾可能摧毁数据中心。此外，硬件的物理损坏，如硬盘故障、电源问题，也可能导致数据丢失。定期备份数据并存储在异地（如云存储或异地数据中心），可以在灾难发生时迅速恢复关键业务功能，减少停机时间和经济损失。
- **防止误删：抵御人为错误。**人类操作难免出错，无论是管理员误删关键文件，还是用户覆盖了重要文档的旧版本，都会导致数据丢失。备份提供了数据的历史快照，允许用户在发生错误后回溯到之前的版本，从而有效挽回损失。
- **防勒索软件：恢复被加密的数据。**勒索软件攻击日益猖獗，攻击者通过加密受害者的数据并索要赎金，严重威胁到企业和个人的信息安全。如果没有可靠的备份，受害者可能面临支付赎金或完全失去数据的窘境。备份可以让用户在遭遇勒索攻击后快速恢复数据，而无需向攻击者妥协。
- **防病毒和恶意软件：恢复被破坏的数据。**除了勒索软件，其他类型的恶意软件也可能破坏数据完整性。例如，病毒感染可能导致文件损坏或丢失。拥有定期更新的备份，可以在系统感染后恢复到清洁的状态，避免恶意软件造成更大影响。
- **长远性和可追溯性：满足法律合规和审计需求。**一些行业和地区的法规要求企业保留数据以备审计或法律用途。备份可以确保数据的完整性和可追溯性，同时避免因数据丢失而导致的法律责任。

# 设计备份方案

## 识别关键数据

- 确定哪些数据对于业务的持续运作至关重要。
- 分类数据的优先级（例如核心业务数据、客户信息、日志文件等）。

例如，以云上对象存储服务来讲，以下的关键数据，需要进行备份：

- 对象存储服务的管控平面数据，包括对象存储服务有哪些组件，配置是什么，分别部署在哪些集群，部署的方式等等。这部分数据是对象存储运行的基础数据，数据量非常少，通常不超过100MiB。
- 用户在对象存储中的bucket、object的元数据。

## 明确恢复目标

- **RPO（恢复点目标）**：可接受的数据丢失范围（如最多丢失最后1小时的数据）。
- **RTO（恢复时间目标）**：从灾难发生到系统恢复的时间目标。

通过RPO，我们可以决定备份的频率，例如：

- **实时备份**：对频繁更新的关键数据进行持续同步。
- **每日备份**：适用于中等重要性数据。
- **定期备份**：如每周或每月，针对长期保存或低变化的数据。

选择备份频率时需权衡性能、存储成本和恢复目标。

## 明确备份的方式

从备份产生恢复点的个数来讲，有以下几种常见的备份方式：

- 定时备份：每次备份产生一个恢复点，多次备份会产生多个恢复点。每次备份可采用全量备份或增量备份。
- 持续备份：实时将数据备份至其它位置（通常只备份增量数据），有无数个恢复点，用户可以将数据恢复至先前的任意时刻。
- 数据同步：实时将数据同步至其它位置，只有一份最新的恢复点。

定时备份、持续备份和数据同步之间的区别：

|  | 定时备份 | 持续备份 | 数据同步 |
| --- | --- | --- | --- |
| 恢复点个数 | 多个恢复点，每次备份生成一个恢复点 | 理论上无数个恢复点。可以恢复到一段时间内的任意一个时刻。 | 只有一个恢复点，即最近同步的数据 |
| RPO | 取决于备份间隔。 | RPO 较短，通常是几秒。 | RPO 较短 |
| RTO | 取决于恢复方式。 | 取决于恢复方式。 | RTO 较短。故障后通常可以快速切换至另一系统。 |
| 优势 | 逻辑简单。
可以有多个恢复点。 | RPO 较短 | RTO 较小，容灾切换速度较快。

RPO 较小，基本上是秒级或分钟级。
 |
| 劣势 | RTO较大，因为需要把冷数据加载出来，视数据量的大小，通常需要分钟至小时级别。

RPO较大，因为是冷数据备份，因此备份动作通常是周期性进行，最差情况可能丢失一整个周期的数据。 | 通常只有特定的备份源支持，例如部分数据库。 | 通常需要做同步复制，技术方案较复杂。

无法防误删除。因为源端数据被删除后，目的端的数据可能也因为同步而被删除。 |
| 场景 | 数据被误删的恢复，数据被串改，防勒索等。 | 同定时备份。 | 容灾场景。当源头无法提供服务时，可以切换至另一实例。 |

针对备份保存的位置，可以分为：

- 同 Region 备份
- 跨 Region 备份

## 考虑恢复

备份后，并不是万事大吉了，需要进一步考虑备份后的恢复能力。包括：

- 恢复是否可行。例如对于ECS实例备份，可以通过恢复点，创建一个新的ECS实例，来验证恢复是否有效可行。
- 恢复的RTO是否符合预期。备份是为了保证业务的稳定性，特别是业务的可用性。
- 备份的数据是否全面，在可预期的故障发生（误删、机房失火等）后，依靠备份是否可以完整恢复出原生的业务。如果答案是否定的，那么意味着备份数据可能还不够全面。


# 核心数据存储方案推荐

这里的“核心数据”主要是指管控平面的数据，通常存储于SQL数据库，bytekv数据库、etcd、zk等，数据量不大，但很重要。

- MySQL
- Etcd
- ZooKeeper

用于存储关键核心数据的关键的选型原则：

- 高可用（例如单点故障不丢数据）
- 尽可能不要依赖其它的服务：否则所依赖服务也要考虑高可用、冷热备等一系列问题。
- 具备冷备、热备的能力
- 具备对数据并发修改的控制机制（例如原子性、隔离性、CAS等）

# 容灾要求

![Untitled](https://ahan-ai.notion.site/image/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F6a0a71fd-e2d2-4bb5-9b46-3b3bf7499109%2FUntitled.png?table=block&id=5cd77756-de2e-4123-968c-6e8e01b53b4a&spaceId=3841c813-6aff-406c-8c94-6fa3c0018b15&width=1420&userId=&cache=v2)

应用于金融领域的云计算平台至少达到3级要求。

3级对备份的要求：

- 关键数据至少有1个数据副本处于异地或同城可用区
- 完全数据备份至少每天1次且 处于同城或异地可用区

# 冷备

冷备，通常来说，对于目标端的要求比较高，推荐的做法是把冷备数据存在对象存储服务中。

对象存储通常还有跨 region 同步的功能，直接打开此功能，就可以自动保证数据跨region备份。

## 数据恢复

技术考量点：

- 数据恢复要明确恢复的时间点，时间点越细越好，能恢复到任意时间点最佳。
- 恢复至新实例/恢复至原实例（可能导致原实例保存点之后的新数据丢失）
- 数据恢复尽可能要白屏化，因为在真正发生故障时，使用黑屏可能会手忙脚乱，导致最终的 RTO 非常长。
- 核心数据库故障后，可能白屏化的能力不一定有了，

针对不同的场景，恢复手段也有不同：

1. 数据**完全丢失**（比如被误删所有数据）：
    1. 如果热备正常，且可以切换，那么直接切到热备上继续工作。这样可以继续工作。
    2. 如果热备也不正常（比如热备由于实时同步导致数据也被删光），那么需要用冷备数据恢复。恢复时长可能取决于数据量。
2. 数据**部分丢失**（通常是被软件或者手动误操作删除）。这种时候通常热备也会由于同样的原因，数据部分丢失，因此这时候热备通常也是用不了的。而直接用冷备恢复，又可能导致很多新的数据丢失。因此这时候，可能需要支持精准地恢复丢失的这部分数据：
    1. 确定误操作的时间点；
    2. 从冷备（包含丢失数据）上恢复到新实例
    3. 对比原实例和新实例（包含丢失数据）的 diff，并精确地从新实例处同步部分数据过来。

对于核心数据库而言，最好有备案，可以快速把新实例里的数据（被误删的那些），一键导入到原实例中。

如果数据过于分散，那只能用脚本来实现导出导入了，这种情况下的恢复时间可能就更长了，具体问题具体分析了。

总之，数据恢复，需要根据不同的场景（黑屏/白屏、数据全丢/部分丢失）提前准备好充分的预案，在故障后紧急修复。

# 热备

数据库类的热备通常方案就是DTS。

# 参考资料

**云计算技术金融应用规范 容灾：**

[金融标准全文公开系统](https://www.cfstc.org/bzgk/gk/view/bzxq.jsp?i_id=1877)

**云计算技术金融应用规范 技术架构**

[金融标准全文公开系统](https://www.cfstc.org/bzgk/gk/view/bzxq.jsp?i_id=1875)

**云计算技术金融应用规范 安全技术要求**

[金融标准全文公开系统](https://www.cfstc.org/bzgk/gk/view/bzxq.jsp?i_id=1876)