# 阶段性发布

按区域、用户群体或其他维度，将新版本逐步扩展到更多用户：

1. 选择一个区域或小范围用户进行试点发布。
2. 试点成功后，逐步扩展到更多区域或用户群体，最终实现全量发布。

优点：

- 与金丝雀发布类似，但更加侧重分区域或分业务推进。
- 风险集中在特定区域，便于快速隔离问题。

缺点：

- 发布周期较长，可能拖延新功能上线时间。
- 不适合需要快速全量部署的场景。

下面是一个具体的示例。

![灰度.drawio (1).png](https://ahan-ai.notion.site/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F3841c813-6aff-406c-8c94-6fa3c0018b15%2Fce7d278b-1a59-438d-801c-bec442f531ab%2F%25E7%2581%25B0%25E5%25BA%25A6.drawio_(1).png?table=block&id=164eda9f-236a-8021-ab38-faa99646a5e5&spaceId=3841c813-6aff-406c-8c94-6fa3c0018b15&width=1030&userId=&cache=v2)

产品 A 开始进行线上变更。由于产品 A 部署在多个区域（Region），我们选择以区域为第一级灰度发布的粒度。

在每个区域内，通过自动化工作流完成升级操作，升级过程简单划分为 **管控平面升级** 和 **数据集群升级** 两部分。数据集群分布在多个 Kubernetes 集群中，每个集群均可独立升级。

**灰度发布流程如下：**

- **批次 1**：首先选择一个 Kubernetes 集群进行升级，以观察升级的效果和潜在问题。
- **批次 2**：若首批升级无异常，则扩大范围，选择更多的集群进行升级。
- **批次 3**：最终完成全量升级。

具体的批次选择策略（灰度策略）可根据服务的实际情况灵活调整。但整体原则始终是从小范围开始验证，逐步加速并扩大升级范围，以确保变更的安全性和可控性。

# 金丝雀发布

金丝雀发布是通过逐步将新版本的流量从小范围扩展到全量范围来降低风险的策略：

1. 将新版本部署到少量实例或小范围用户（“金丝雀”）中，观察运行情况。
2. 如果没有问题，逐步增加流量比例或用户范围，直到覆盖所有用户。
3. 若发现问题，可快速停止流量或回滚到旧版本。

# 滚动发布

滚动发布是一种通过逐步将旧版本的实例替换为新版本实例的策略。

- 旧版本实例逐一被新版本替换，直到所有实例都运行新版本。
- 期间只有一部分实例运行新版本，其余实例继续运行旧版本，服务始终在线。

## Kubernetes 中的滚动发布

以一个运行 5 个副本的 Deployment 为例，以下是滚动发布的具体过程：

1. **触发升级**
    - 使用 `kubectl apply` 命令更新 Deployment 的 YAML 文件中的镜像版本或配置。
    - Kubernetes 检测到 Deployment 的配置变更，启动滚动发布过程。
    
    示例命令：
    
    ```bash
    kubectl apply -f deployment.yaml
    ```
    
2. **逐步替换旧版本 Pod**
    - **新增一个新版本 Pod**：Deployment 控制器首先启动一个运行新版本的 Pod。
    - **终止一个旧版本 Pod**：确认新版本 Pod 运行正常后，删除一个旧版本 Pod。
    - 重复上述步骤，直到所有旧版本 Pod 都被替换为新版本。
3. **监控和健康检查**
    - Kubernetes 在每次新增或终止 Pod 时都会通过探针（Readiness/Liveness Probe）检查 Pod 的健康状态。
    - 如果新版本 Pod 出现问题，滚动发布会暂停，等待用户介入或自动回滚。
4. **完成升级**
    - 当所有 Pod 都运行新版本，并且健康状态正常时，滚动发布完成。

滚动发布可以通过 Deployment 的 **`spec.strategy`** 字段进行配置。以下是一个 YAML 文件的示例：

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: my-app
spec:
  replicas: 5
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 1   # 升级过程中最多有 1 个不可用的 Pod
      maxSurge: 1         # 升级过程中最多比目标副本数多 1 个 Pod
  selector:
    matchLabels:
      app: my-app
  template:
    metadata:
      labels:
        app: my-app
    spec:
      containers:
      - name: my-container
        image: my-image:v2  # 新版本镜像
        ports:
        - containerPort: 80

```

# 蓝绿发布

蓝绿发布是一种通过运行两个独立环境（蓝色和绿色）来实现无中断部署的策略：

- **蓝色环境**：当前的生产环境，运行旧版本的服务。
- **绿色环境**：一个独立的环境，用于部署新版本的服务。

部署流程如下：

1. 在绿色环境中部署并测试新版本。
2. 测试完成后，将流量切换到绿色环境（通常通过负载均衡实现）。
3. 如果新版本出现问题，可以迅速切换回蓝色环境，恢复旧版本服务。

优点：

- 流量切换简单，回滚速度快。
- 绿色环境可以完全隔离，用于充分测试新版本。

缺点：

- 需要双倍的基础设施（两个环境同时存在），成本较高。
- 流量切换可能会导致会话丢失，需要额外处理。

# **A/B 测试发布**

将用户分成不同的群组，分别访问旧版本（A）和新版本（B），对比其表现：

- 按用户特征（如地域、浏览器类型）或随机分配流量。
- 新版本和旧版本在同一时间运行，通过监测新版本的用户行为和反馈来决定是否逐步扩大流量。

优点：

- 精确验证新版本对用户的影响。
- 可用于功能优化和用户体验改进的效果评估。

缺点：

- 需要完善的流量分组和数据监控系统。
- 新旧版本可能需要同时处理同一用户的数据，增加复杂性。

# 功能开关发布

通过代码中的功能开关（Feature Toggle）控制新功能的开启与关闭：

- 将新功能代码与旧版本代码一起部署，但新功能默认关闭。
- 一旦部署完成，可逐步开启新功能（按用户、区域、业务粒度）。

优点：

- 部署与功能上线解耦，极大降低部署风险。
- 回滚时只需关闭开关，无需回滚部署。

缺点：

- 功能开关代码会增加代码复杂性，长期维护成本较高。
- 开关的滥用可能导致技术债务积累。